var express = require('express');
var multer = require('multer');
var q = require('q');

var ImageKit = require("../src/index.js");

var app = new express();
app.set("views", "./views");
app.set("view engine", "jade");

var imagekit = new ImageKit({
    "imagekitId" : "demo", /* required */
    "apiKey" : "myapikey", /* required */
    "apiSecret" : "myapisecret", /* required and to be kept secret */
    "useSubdomain" : false,
    "useSecure" : false
});


//using the jade templating engine to render a img tag with the required source url
app.get("/demo-page.html", function(req, res) {
    var url = imagekit.image("default-image.jpg")
              .transform({HEIGHT : 100, WIDTH : 200, CROP_MODE : "resize"})
              .transform({BORDER : "5_FF0000"})
              .signedUrl(0);

    var html = imagekit.image("default-image.jpg")
              .transform({HEIGHT : 300})
              .html({
                className : "image-item",
                id : "ik-image"
              });

    res.render("demo", {
        "url" : url,
        "html" : html
    });
});

/*
    Sample API endpoint that can accept 1 file in the same request
    The files should be available as variable 'image' in the request
    This sample uses multer module for handling multipart form data
    and 'q' for handling promises
 */
var upload = multer().single('image');
app.post("/rest/api/upload", function(req, res) {
    //use some authentication on the incoming request like login if needed at this step
    
    //invoke the multer middleware manually for error handling
    //can be done automatically, read multer docs for the same 
    upload(req, res, function(err) {
        if(err) {
            res.status(500);
            res.send({
                "exception" : true,
                "statusNumber" : 500,
                "statusCode" : "INTERNAL_SERVER_ERROR",
                "message" : "Image file parsing failed"
            });
            return;
        }

        var uploadPromise;
        uploadPromise = imagekit.upload(req.file.buffer.toString('base64'), {
            "filename" : req.file.originalname,
            "folder" : "/images"
        });
       
        //handle upload success and failure
        uploadPromise.then(function(result) {
            res.send(result);
        }, function(err) {
            res.status(500);
            res.send({
                "exception" : true,
                "statusNumber" : err.statusNumber,
                "statusCode" : err.statusCode,
                "message" : err.message
            });
        });

    });
});

app.listen(3456);
console.log("App listening on port 3456.\nOpen http://localhost:3456/demo-page.html in your browser");
